---
// ClassicSelectionOptionsWithoutBundles.astro - Enhanced with new observer
import "./classicSelectionOptionsWithoutBundles.css";
import type { CustomOptions, Product } from "../../../../../../lib/api/types";
import { detectColorOption } from "../../../../../../lib/utils/Custom-Options-utils";
import { getTranslation } from "../../../../../../lib/utils/i18n/translations";
import ClassicColorOptionsWithoutBundles from "./Color Options/ClassicColorOptionsWithoutBundles.astro";
import ClassicTextOptionsWithoutBundles from "./Text Options/ClassicTextOptionsWithoutBundles.astro";

const product: Product = Astro.props.product;
const panelIndex: number = 1;
const qty_NonVariant = product.qty;
const isHaveVariant = product.is_have_variant;
const customOptions: CustomOptions[] = product.custom_options;

// Component configuration
const allowMultipleSelection = false;
const showSelectionIndicators = true;
const enableAutoSelect = false;

// Clean data extraction with enhanced properties (keeping your existing structure)
let optionData: any = null;
const skuNoVariant = product.sku_code;
const priceNoVariant = product.price;
const priceAfterDiscountNoVariant = product.price_after_discount;

if (isHaveVariant === "true" && customOptions) {
    // Extract options in original JSON order
    const optionEntries = Object.entries(customOptions);
    
    const firstOption = optionEntries[0] ? {
        key: optionEntries[0][0],
        title: optionEntries[0][0],
        values: optionEntries[0][1]
    } : null;
    
    const secondOption = optionEntries[1] ? {
        key: optionEntries[1][0], 
        title: optionEntries[1][0],
        values: optionEntries[1][1]
    } : null;
    
    // Detect which option should show colors
    const colorDetection = detectColorOption(firstOption, secondOption);
    
    // Build associations for filtering with enhanced data (keeping your structure)
    const associations: any = {};
    if (firstOption && secondOption) {
        firstOption.values.forEach(firstValue => {
            const availableSecondOptions = firstValue.available_options?.[secondOption.key];
            if (availableSecondOptions && Array.isArray(availableSecondOptions)) {
                associations[firstValue.value] = availableSecondOptions.map(item => ({
                    value: item.value,
                    sku_id: item.sku_id,
                    hex: item.hex || null,
                    price: item.price || null,
                    price_after_discount: item.price_after_discount || null,
                    image: item.image || null,
                    qty: item.qty || 1,
                    ...item
                }));
            }
        });
    }
    
    // Create enhanced option metadata maps for quick lookups (keeping your structure)
    const firstOptionMetadata: any = {};
    const secondOptionMetadata: any = {};
    
    if (firstOption) {
        firstOption.values.forEach(value => {
            firstOptionMetadata[value.value] = {
                hex: value.hex || null,
                price: value.price || null,
                price_after_discount: value.price_after_discount || null,
                image: value.image || null,
                qty: value.qty || 1
            };
        });
    }
    
    if (secondOption) {
        secondOption.values.forEach(value => {
            secondOptionMetadata[value.value] = {
                hex: value.hex || null,
                price: value.price || null,
                price_after_discount: value.price_after_discount || null,
                image: value.image || null,
                qty: value.qty || 1
            };
        });
    }
    
    // Create clean data structure with enhanced metadata (keeping your structure)
    optionData = {
        firstOption: firstOption ? {
            ...firstOption,
            hasColors: colorDetection.firstHasColors
        } : null,
        secondOption: secondOption ? {
            ...secondOption, 
            hasColors: colorDetection.secondHasColors
        } : null,
        associations,
        firstOptionMetadata,
        secondOptionMetadata,
        basePrice: product.price || null,
        basePriceAfterDiscount: product.price_after_discount || null,
        baseImage: product.image || null
    };
}
---

<div id="classic-pannel-container" class="classic-pannel-container">
  <classic-select-options 
    data-options-panel-index={panelIndex}
    data-options-allow-multiple={allowMultipleSelection}
    data-options-show-indicators={showSelectionIndicators}
    data-options-auto-select={enableAutoSelect}
    data-options-is-variant={isHaveVariant}
    data-option-data={optionData ? JSON.stringify(optionData) : ''}
    data-sku-no-variant={skuNoVariant}
    data-base-price={priceNoVariant || ''}
    data-base-price-discount={priceAfterDiscountNoVariant || ''}
    data-base-image={product.image || ''}
    data-qty-non-variant={qty_NonVariant || 1}
  >
    <div class="classic-single-option-panel p-7">
      <div class="flex flex-col gap-6 lg:flex-row lg:gap-8">
        
        <!-- OPTIONS SECTION -->
        {isHaveVariant === "true" ? (
          <div class="flex-1">
            <div class="space-y-6">
              <!-- First Option -->
              {optionData?.firstOption && (
                <div class="classic-select-option-section">
                  <h3 class="text-sm font-medium text-gray-700 mb-3">{optionData.firstOption.title}</h3>
                  {optionData.firstOption.hasColors ? (
                    <div class="flex flex-wrap gap-3">
                      {optionData.firstOption.values.map((option, index) => (
                        <ClassicColorOptionsWithoutBundles 
                          option={option}
                          index={index}
                          optionType="first"
                        />
                      ))}
                    </div>
                  ) : (
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                      {optionData.firstOption.values.map((option, index) => (
                        <ClassicTextOptionsWithoutBundles 
                          option={option}
                          index={index}
                          optionType="first"
                        />
                      ))}
                    </div>
                  )}
                </div>
              )}
              
              <!-- Second Option -->
              {optionData?.secondOption && (
                <div class="classic-select-option-section">
                  <h3 class="text-sm font-medium text-gray-700 mb-3">{optionData.secondOption.title}</h3>
                  {optionData.secondOption.hasColors ? (
                    <div class="flex flex-wrap gap-3">
                      {optionData.secondOption.values.map((option, index) => (
                        <ClassicColorOptionsWithoutBundles 
                          option={option}
                          index={index}
                          optionType="second"
                        />
                      ))}
                    </div>
                  ) : (
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                      {optionData.secondOption.values.map((option, index) => (
                        <ClassicTextOptionsWithoutBundles 
                          option={option}
                          index={index}
                          optionType="second"
                        />
                      ))}
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        ) : null}
        
        <!-- QUANTITY SECTION -->
        <div class="flex-1 lg:max-w-xs">
          <div class="space-y-4">
            
            <!-- Quantity Controls -->
            <div class="classic-qty-section">
              <label class="block text-sm font-medium text-gray-700 mb-3">
                Quantity
              </label>
              <div class="flex items-center gap-3">
                <button 
                  type="button" 
                  class="classic-qty-btn classic-qty-decrease w-10 h-10 flex items-center justify-center border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  data-qty-action="decrease"
                >
                  <span class="text-lg font-medium select-none">âˆ’</span>
                </button>
                
                <input 
                  type="number" 
                  class="classic-qty-input w-20 h-10 text-center border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" 
                  value="1" 
                  min="1" 
                  data-qty-input
                />
                
                <button 
                  type="button" 
                  class="classic-qty-btn classic-qty-increase w-10 h-10 flex items-center justify-center border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  data-qty-action="increase"
                >
                  <span class="text-lg font-medium select-none">+</span>
                </button>
              </div>
              
              <!-- ðŸ†• Enhanced max quantity indicator with automatic updates -->
              {isHaveVariant === "true" && (
                <div class="classic-max-qty-indicator mt-2 text-sm text-gray-500" data-max-qty-display style="display: none;">
                  <span>Max available: <span data-max-qty-value class="font-medium">0</span></span>
                </div>
              )}
            </div>
            
            <!-- ðŸ†• Enhanced Selection Status with automatic updates -->
            {isHaveVariant === "true" && (
              <div class="classic-selection-status">
                <h4 class="text-sm font-medium text-gray-800 mb-2">Current Selection</h4>
                <div class="space-y-2 text-sm">
                  {optionData?.firstOption && (
                    <div class="flex justify-between">
                      <span class="text-gray-600">{optionData.firstOption.title}:</span>
                      <span class="font-medium" data-selected-first-option>Not selected</span>
                    </div>
                  )}
                  {optionData?.secondOption && (
                    <div class="flex justify-between">
                      <span class="text-gray-600">{optionData.secondOption.title}:</span>
                      <span class="font-medium" data-selected-second-option>Not selected</span>
                    </div>
                  )}
                </div>
                
                <!-- ðŸ†• Price display that updates automatically -->
                <div class="classic-price-display mt-3 pt-3 border-t border-gray-200" data-price-display style="display: none;">
                  <div class="text-sm space-y-1">
                    <div class="flex justify-between" data-original-price-row style="display: none;">
                      <span class="text-gray-600">Price:</span>
                      <span class="font-medium line-through text-gray-500" data-original-price></span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-600">Final Price:</span>
                      <span class="font-bold text-green-600" data-final-price></span>
                    </div>
                  </div>
                </div>
                
                <!-- ðŸ†• SKU display that updates automatically -->
                <div class="classic-sku-display mt-2" data-sku-display style="display: none;">
                  <div class="text-xs text-gray-500">
                    SKU: <span data-current-sku class="font-mono"></span>
                  </div>
                </div>
              </div>
            )}
            
            <!-- Product Info for Non-Variants -->
            {isHaveVariant !== "true" && (
              <div class="classic-product-info">
                <h4 class="text-sm font-medium text-gray-800 mb-2">Product Details</h4>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-gray-600">SKU:</span>
                    <span class="font-medium">{skuNoVariant}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Available:</span>
                    <span class="font-medium text-green-600">{qty_NonVariant || 1} units</span>
                  </div>
                  {priceNoVariant && (
                    <div class="flex justify-between">
                      <span class="text-gray-600">Price:</span>
                      <span class="font-bold text-green-600">${priceAfterDiscountNoVariant || priceNoVariant}</span>
                    </div>
                  )}
                </div>
              </div>
            )}
            
            <!-- ðŸ†• Clear selections button for variants -->
            {isHaveVariant === "true" && (
              <button 
                type="button" 
                class="classic-clear-btn w-full py-2 px-4 text-sm border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
                data-clear-selections
              >
                Clear Selections
              </button>
            )}
            
          </div>
        </div>
        
      </div>
    </div>
  </classic-select-options>
</div>

<script>
  import "./classicSelectionOptionsWithoutBundles";
  
  // ðŸ†• Enhanced script for automatic price/sku updates
  document.addEventListener('DOMContentLoaded', () => {
    const selectOptions = document.querySelector('classic-select-options');
    
    if (selectOptions) {
      // Listen for observer state changes to update price/sku displays
      selectOptions.addEventListener('first-option-selected', (event) => {
        updatePriceAndSkuDisplay(event.detail.observerState);
      });
      
      selectOptions.addEventListener('second-option-selected', (event) => {
        updatePriceAndSkuDisplay(event.detail.observerState);
      });
      
      // Clear selections button
      const clearBtn = document.querySelector('[data-clear-selections]');
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          if (selectOptions.clearSelections) {
            selectOptions.clearSelections();
          }
        });
      }
      
      selectOptions.addEventListener('selections-cleared', () => {
        hidePriceAndSkuDisplay();
      });
    }
  });
  
  function updatePriceAndSkuDisplay(observerState) {
    const option = observerState.option;
    const isComplete = observerState.isSelectionComplete;
    
    // Update price display
    const priceDisplay = document.querySelector('[data-price-display]');
    const originalPriceRow = document.querySelector('[data-original-price-row]');
    const originalPrice = document.querySelector('[data-original-price]');
    const finalPrice = document.querySelector('[data-final-price]');
    
    if (priceDisplay && finalPrice) {
      if (option.price || option.price_after_discount) {
        priceDisplay.style.display = 'block';
        
        const hasDiscount = option.price && option.price_after_discount && option.price > option.price_after_discount;
        
        if (hasDiscount && originalPriceRow && originalPrice) {
          originalPriceRow.style.display = 'flex';
          originalPrice.textContent = `$${option.price}`;
          finalPrice.textContent = `$${option.price_after_discount}`;
        } else {
          if (originalPriceRow) originalPriceRow.style.display = 'none';
          finalPrice.textContent = `$${option.price_after_discount || option.price}`;
        }
      }
    }
    
    // Update SKU display
    const skuDisplay = document.querySelector('[data-sku-display]');
    const currentSku = document.querySelector('[data-current-sku]');
    
    if (skuDisplay && currentSku && option.sku_id && isComplete) {
      skuDisplay.style.display = 'block';
      currentSku.textContent = option.sku_id.toString();
    } else if (skuDisplay) {
      skuDisplay.style.display = 'none';
    }
  }
  
  function hidePriceAndSkuDisplay() {
    const priceDisplay = document.querySelector('[data-price-display]');
    const skuDisplay = document.querySelector('[data-sku-display]');
    
    if (priceDisplay) priceDisplay.style.display = 'none';
    if (skuDisplay) skuDisplay.style.display = 'none';
  }
</script>