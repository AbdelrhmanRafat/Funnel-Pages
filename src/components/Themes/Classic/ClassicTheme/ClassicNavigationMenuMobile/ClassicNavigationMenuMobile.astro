---
import "./ClassicNavigationMenuMobile.css"
import type { Data } from "../../../../../lib/api/types";
import { FunnelClassicComponents } from "../../../../../lib/constants/themes";
import { getClassicThemeComponent } from "../../../../../lib/utils/ThemeSelect";
import type { Language } from "../../../../../lib/utils/i18n/translations";

const funnelPage: Data = Astro.props.funnelPage;
const logo: string = Astro.props.logo;
const title: string = Astro.props.title;

// Generate anchors from available components with comprehensive null checking
const availableAnchors = funnelPage?.blocks
  ?.map((block) => {
    // Check if block exists and has required properties
    if (!block || !block.name || !block.data) {
      return null;
    }

    const component = getClassicThemeComponent(block.name);
    
    // Check if component exists and has title from API
    if (component && block.data?.title) {
      return {
        component: component,
        componentData: block.data
      };
    }
    return null;
  })
  ?.filter((anchor): anchor is NonNullable<typeof anchor> => anchor !== null) || [];

// Define render order - WITHOUT header (as originally requested)
const RENDER_ORDER = [
  FunnelClassicComponents.ClassicProductFunnel, // Always render (required)
  FunnelClassicComponents.ClassicProductFeatures,
  FunnelClassicComponents.ClassicProductPreview,
  FunnelClassicComponents.ClassicProductUsage,
  FunnelClassicComponents.classicLogosCarousel,
  FunnelClassicComponents.ClassicButtonWithLink,
  FunnelClassicComponents.classicTodayStatistics,
  FunnelClassicComponents.ClassicGallery,
  FunnelClassicComponents.Classic_Before_After,
  FunnelClassicComponents.ClassicReviews,
  FunnelClassicComponents.ClassicTextBar,
  FunnelClassicComponents.ClassicImageTextOverLay,
  FunnelClassicComponents.ClassicImageTextBeside,
  FunnelClassicComponents.ClassicFaq,
  FunnelClassicComponents.ClassicDeliveryFeatures,
  FunnelClassicComponents.ClassicCountdown,
  FunnelClassicComponents.ClassicFooter,
];

// Get initial language from cookie during SSR
const currentLang: Language = (Astro.cookies.get("lang")?.value || "en") as Language;
const isArabic = currentLang === "ar";
// Safe filtering with additional null checks
const orderedAnchors = RENDER_ORDER
  .map(component => {
    const foundAnchor = availableAnchors.find(anchor => 
      anchor && anchor.component === component
    );
    return foundAnchor || null;
  })
  .filter((anchor): anchor is NonNullable<typeof anchor> => {
    // Ensure anchor exists and has required properties
    return (
      anchor !== null &&
      !!anchor.component &&
      !!anchor.componentData &&
      !!anchor.componentData.title &&
      typeof anchor.componentData.title === 'string' &&
      anchor.componentData.title.trim() !== ''
    );
  });
---

<!-- Mobile Navigation Menu Overlay - Only visible on mobile -->
<div 
  id="header-menu-overlay" 
  class="classic-menu-overlay fixed top-0 left-0 w-full h-full z-60"
>
  <!-- Backdrop for closing menu -->
  <div 
    class="classic-menu-backdrop absolute top-0 left-0 w-full h-full" 
    id="header-menu-backdrop"
  ></div>
  
  <!-- Menu Content -->
  <div class="classic-menu-content absolute top-0 right-0 h-full w-80 max-w-[85vw] p-6 overflow-y-auto">
    <!-- Menu Header -->
    <div class="classic-menu-header flex justify-between items-center mb-8 pb-4">
      <div class="w-32">
        <img src={logo} alt={title || "Logo"} class="w-full" />
      </div>
      <button
        id="header-menu-close"
        class="classic-menu-close p-2 rounded-lg w-10 h-10 flex items-center justify-center transition-all duration-300"
        aria-label="Close menu"
        type="button"
      >
        <i class="fa-solid fa-times text-xl"></i>
      </button>
    </div>
    
    <!-- Menu Items with API Titles -->
    <nav class="classic-menu-nav flex-1" role="navigation" aria-label="Main navigation">
      <ul class="classic-menu-list space-y-2" role="list">

        <!-- Auto-generated navigation items -->
        {orderedAnchors.map((anchor, index) => {
          // Additional safety check during rendering
          if (!anchor || !anchor.component || !anchor.componentData?.title) {
            return null;
          }
          
          return (
            <li 
              class="classic-menu-item transition-all duration-300 ease-out"
              role="listitem"
              style={`--menu-item-index: ${index + 1}`}
            >
              <a
                href={`#${anchor.component}`}
                class="classic-menu-link block p-3 rounded-lg text-sm font-medium transition-all duration-300"
                data-anchor-target={anchor.componentData.title}
              >
                    {isArabic ?   anchor.componentData.title_ar : anchor.componentData.title_en}
                  </a>
            </li>
          );
        })}
      </ul>
    </nav>
  </div>
</div>