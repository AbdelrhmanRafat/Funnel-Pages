---
import "./ClassicNavigationMenuDesktop.css";
import type { Data } from "../../../../../lib/api/types";
import { FunnelClassicComponents } from "../../../../../lib/constants/themes";
import { getClassicThemeComponent } from "../../../../../lib/utils/ThemeSelect";

const funnelPage: Data = Astro.props.funnelPage;

// Generate anchors from available components with comprehensive null checking
const availableAnchors = funnelPage?.blocks
  ?.map((block) => {
    // Check if block exists and has required properties
    if (!block || !block.name || !block.data) {
      return null;
    }

    const component = getClassicThemeComponent(block.name);
    
    // Check if component exists and has title from API
    if (component && block.data?.title) {
      return {
        component: component,
        componentData: block.data
      };
    }
    return null;
  })
  ?.filter((anchor): anchor is NonNullable<typeof anchor> => anchor !== null) || [];

// Order anchors based on render order
const RENDER_ORDER = [
  FunnelClassicComponents.ClassicProductFunnel, // Always render (required)
  FunnelClassicComponents.ClassicProductFeatures,
  FunnelClassicComponents.ClassicProductPreview,
  FunnelClassicComponents.ClassicProductUsage,
  FunnelClassicComponents.classicTodayStatistics,
  FunnelClassicComponents.ClassicGallery,
  FunnelClassicComponents.Classic_Before_After,
  FunnelClassicComponents.ClassicReviews,
  FunnelClassicComponents.ClassicTextBar,
  FunnelClassicComponents.ClassicImageTextOverLay,
  FunnelClassicComponents.ClassicImageTextBeside,
  FunnelClassicComponents.ClassicFaq,
  FunnelClassicComponents.ClassicDeliveryFeatures,
  FunnelClassicComponents.ClassicCountdown,
  FunnelClassicComponents.ClassicFooter,
];

// Safe filtering with additional null checks
const orderedAnchors = RENDER_ORDER
  .map(component => {
    const foundAnchor = availableAnchors.find(anchor => 
      anchor && anchor.component === component
    );
    return foundAnchor || null;
  })
  .filter((anchor): anchor is NonNullable<typeof anchor> => {
    // Ensure anchor exists and has required properties
    return (
      anchor !== null &&
      !!anchor.component &&
      !!anchor.componentData &&
      !!anchor.componentData.title &&
      typeof anchor.componentData.title === 'string' &&
      anchor.componentData.title.trim() !== ''
    );
  });
---

<!-- Option B: Enhanced Desktop Navigation with Optimized Overflow -->
{orderedAnchors && orderedAnchors.length > 0 && (
  <desktop-navigation 
    class="classic-desktop-nav hidden md:block w-full mt-4 pt-4"
    data-navigation-items={JSON.stringify(orderedAnchors.map(anchor => ({
      id: anchor.component,
      title: anchor.componentData.title
    })))}
    data-max-visible-items="6"
    data-overflow-threshold="800"
  >
    <nav class="flex items-center justify-center">
      <div class="relative flex items-center">
        <!-- Main Navigation Container -->
        <div 
          class="nav-container flex items-center overflow-hidden transition-all duration-300" 
          data-nav-container
        >
          <ul class="flex items-center gap-2 transition-all duration-300" data-nav-list>
            {orderedAnchors.map((anchor, index) => {
              // Additional safety check during rendering
              if (!anchor || !anchor.component || !anchor.componentData?.title) {
                return null;
              }
              
              return (
                <li 
                  class="classic-nav-item flex-shrink-0 transition-all duration-300"
                  data-nav-index={index}
                  data-nav-item
                >
                  <a 
                    href={`#${anchor.component}`}
                    class="classic-desktop-nav-link block px-4 py-2 text-sm font-medium rounded-full transition-all duration-300 hover:scale-105 whitespace-nowrap"
                    data-anchor-target={anchor.componentData.title}
                    data-scroll-target={anchor.component}
                  >
                    {anchor.componentData.title}
                  </a>
                </li>
              );
            })}
          </ul>
        </div>

        <!-- Overflow Indicator Dots -->
        <div 
          class="classic-nav-dots hidden items-center gap-1 mx-3 transition-opacity duration-300" 
          data-nav-dots
        >
          <div class="w-1.5 h-1.5 rounded-full bg-current opacity-60"></div>
          <div class="w-1.5 h-1.5 rounded-full bg-current opacity-80"></div>
          <div class="w-1.5 h-1.5 rounded-full bg-current opacity-60"></div>
        </div>

        <!-- Overflow Dropdown -->
        <div class="classic-nav-overflow relative hidden" data-nav-overflow>
          <button 
            class="classic-overflow-toggle px-4 py-2 text-sm font-medium rounded-full transition-all duration-300 hover:scale-105 flex items-center gap-2"
            data-overflow-toggle
            aria-label="More navigation items"
            type="button"
          >
            <span class="text-sm" data-translate="Headers.more">More</span>
            <i 
              class="fa-solid fa-chevron-down text-xs transition-transform duration-200" 
              data-dropdown-arrow
            ></i>
          </button>
          
          <!-- Dropdown Menu -->
          <div 
            class="classic-overflow-dropdown absolute top-full left-1/2 transform -translate-x-1/2 mt-2 py-2 rounded-lg border min-w-48 z-20 hidden"
            data-overflow-dropdown
          >
            <ul class="overflow-items space-y-1" data-overflow-items>
              <!-- Hidden items will be populated here by the web component -->
            </ul>
          </div>
        </div>
      </div>
    </nav>
  </desktop-navigation>
)}

<script>
  import "./ClassicNavigationMenuDesktop";
</script>