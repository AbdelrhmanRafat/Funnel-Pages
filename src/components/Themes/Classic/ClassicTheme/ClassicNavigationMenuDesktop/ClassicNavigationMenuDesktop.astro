---
import "./ClassicNavigationMenuDesktop.css";
import type { Data } from "../../../../../lib/api/types";
import { FunnelClassicComponents } from "../../../../../lib/constants/themes";
import { getClassicThemeComponent } from "../../../../../lib/utils/ThemeSelect";
const funnelPage: Data = Astro.props.funnelPage;
// Generate anchors from available components with comprehensive null checking
const availableAnchors = funnelPage?.blocks
  ?.map((block) => {
    // Check if block exists and has required properties
    if (!block || !block.name || !block.data) {
      return null;
    }

    const component = getClassicThemeComponent(block.name);
    
    // Check if component exists and has title from API
    if (component && block.data?.title) {
      return {
        component: component,
        componentData: block.data
      };
    }
    return null;
  })
  ?.filter((anchor): anchor is NonNullable<typeof anchor> => anchor !== null) || [];

// Order anchors based on render order
const RENDER_ORDER = [
  FunnelClassicComponents.ClassicProductFeatures,
  FunnelClassicComponents.ClassicProductPreview,
  FunnelClassicComponents.ClassicProductUsage,
  FunnelClassicComponents.ClassicTodayOrders,
  FunnelClassicComponents.Classic_Before_After,
  FunnelClassicComponents.ClassicReviews,
  FunnelClassicComponents.ClassicTextBar,
  FunnelClassicComponents.ClassicImageTextOverLay,
  FunnelClassicComponents.ClassicImageTextBeside,
  FunnelClassicComponents.ClassicFaq,
  FunnelClassicComponents.ClassicDeliveryFeatures,
];
// Safe filtering with additional null checks
const orderedAnchors = RENDER_ORDER
  .map(component => {
    const foundAnchor = availableAnchors.find(anchor => 
      anchor && anchor.component === component
    );
    return foundAnchor || null;
  })
  .filter((anchor): anchor is NonNullable<typeof anchor> => {
    // Ensure anchor exists and has required properties
    return (
      anchor !== null &&
      !!anchor.component &&
      !!anchor.componentData &&
      !!anchor.componentData.title &&
      typeof anchor.componentData.title === 'string' &&
      anchor.componentData.title.trim() !== ''
    );
  });
---
<!-- Enhanced Desktop Navigation with Overflow Handling -->
{orderedAnchors && orderedAnchors.length > 0 && (
          <nav class="classic-desktop-nav hidden md:block w-full mt-4" id="desktop-nav">
            <div class="relative flex items-center justify-center">
              <!-- Visible Navigation Items -->
              <div class="nav-container flex items-center overflow-hidden" id="nav-container">
                <ul class="flex flex-row items-center gap-2 transition-all duration-300" id="nav-list">
                  {orderedAnchors.map((anchor, index) => {
                    if (!anchor || !anchor.component || !anchor.componentData?.title) {
                      return null;
                    }
                    return (
                      <li class="classic-nav-item flex-shrink-0" data-index={index}>
                        <a 
                          href={`#${anchor.component}`}
                          class="classic-desktop-nav-link block px-4 py-2 text-sm font-medium rounded-full transition-all duration-300 whitespace-nowrap hover:scale-105"
                          data-anchor-target={anchor.componentData.title}
                        >
                          {anchor.componentData.title}
                        </a>
                      </li>
                    );
                  })}
                </ul>
              </div>

              <!-- Dots Indicator (shows when items are hidden) -->
              <div class="classic-nav-dots hidden items-center gap-1 mx-2" id="nav-dots">
                <div class="w-1 h-1 rounded-full"></div>
                <div class="w-1 h-1 rounded-full"></div>
                <div class="w-1 h-1 rounded-full"></div>
              </div>

              <!-- Overflow Dropdown -->
              <div class="classic-nav-overflow relative hidden" id="nav-overflow">
                <button 
                  class="classic-overflow-toggle px-3 py-2 text-sm font-medium rounded-full transition-all duration-300 hover:scale-105 flex items-center gap-1"
                  id="overflow-toggle"
                  aria-label="More navigation items"
                >
                  <span data-translate="Headers.more"></span>
                  <i class="fa-solid fa-chevron-down text-xs transition-transform duration-200" id="dropdown-arrow"></i>
                </button>
                
                <!-- Dropdown Menu -->
                <div class="classic-overflow-dropdown absolute top-full left-1/2 transform -translate-x-1/2 mt-2 py-2 rounded-lg shadow-lg border min-w-40 z-10 hidden" id="overflow-dropdown">
                  <ul class="overflow-items" id="overflow-items">
                    <!-- Hidden items will be populated here by JavaScript -->
                  </ul>
                </div>
              </div>
            </div>
          </nav>
 )}
<script>
    import { initEnhancedNavigation } from "./ClassicNavigationMenuDesktop";
    initEnhancedNavigation();
</script>