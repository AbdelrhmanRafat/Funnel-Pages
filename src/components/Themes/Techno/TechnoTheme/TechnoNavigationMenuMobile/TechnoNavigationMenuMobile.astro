---
import "./TechnoNavigationMenuMobile.css"
import type { Data } from "../../../../../lib/api/types";
import { FunnelTechnoComponents } from "../../../../../lib/constants/themes";
import { getTechnoThemeComponent } from "../../../../../lib/utils/ThemeSelect";
import type { Language } from "../../../../../lib/utils/i18n/translations";
import LucideIcon from "../../../../Shared/LucideIcon.astro";

const funnelPage: Data = Astro.props.funnelPage;
const logo: string = Astro.props.logo;
const title: string = Astro.props.title;

// Generate anchors from available components with comprehensive null checking
const availableAnchors = funnelPage?.blocks
  ?.map((block) => {
    // Check if block exists and has required properties
    if (!block || !block.name || !block.data) {
      return null;
    }

    const component = getTechnoThemeComponent(block.name);
    
    // Check if component exists and has title from API
    if (component) {
      return {
        component: component,
        componentData: block.data
      };
    }
    return null;
  })
  ?.filter((anchor): anchor is NonNullable<typeof anchor> => anchor !== null) || [];

// Define render order - WITHOUT header (as originally requested)
const RENDER_ORDER = [
  FunnelTechnoComponents.TechnoProductFunnel, // Always render (required)
  FunnelTechnoComponents.TechnoProductFeatures,
  FunnelTechnoComponents.TechnoProductPreview,
  FunnelTechnoComponents.TechnoProductUsage,
  FunnelTechnoComponents.technoLogosCarousel,
  FunnelTechnoComponents.TechnoButtonWithLink,
  FunnelTechnoComponents.technoTodayStatistics,
  FunnelTechnoComponents.TechnoGallery,
  FunnelTechnoComponents.Classic_Before_After,
  FunnelTechnoComponents.TechnoReviews,
  FunnelTechnoComponents.TechnoTextBar,
  FunnelTechnoComponents.TechnoImageTextOverLay,
  FunnelTechnoComponents.TechnoImageTextBeside,
  FunnelTechnoComponents.TechnoFaq,
  FunnelTechnoComponents.TechnoDeliveryFeatures,
  FunnelTechnoComponents.TechnoCountdown,
  FunnelTechnoComponents.TechnoFooter,
];

// Get initial language from cookie during SSR
const currentLang: Language = (Astro.cookies.get("lang")?.value || "en") as Language;
const isArabic = currentLang === "ar";
// Safe filtering with additional null checks
const orderedAnchors = RENDER_ORDER
  .map(component => {
    const foundAnchor = availableAnchors.find(anchor => 
      anchor && anchor.component === component
    );
    return foundAnchor || null;
  })
  .filter((anchor): anchor is NonNullable<typeof anchor> => {
    // Ensure anchor exists and has required properties
    return (
      anchor !== null &&
      !!anchor.component &&
      !!anchor.componentData &&
      // Check for language-specific titles instead of generic 'title'
      (
        (!!anchor.componentData.title_en && anchor.componentData.title_en.trim() !== '') ||
        (!!anchor.componentData.title_ar && anchor.componentData.title_ar.trim() !== '')
      )
    );
  });
---

<!-- Mobile Navigation Menu Overlay - Only visible on mobile -->
<div 
  id="header-menu-overlay" 
  class="techno-menu-overlay fixed top-0 left-0 w-full h-full z-60"
>
  <!-- Backdrop for closing menu -->
  <div 
    class="techno-menu-backdrop absolute top-0 left-0 w-full h-full" 
    id="header-menu-backdrop"
  ></div>
  
  <!-- Menu Content -->
  <div class="techno-menu-content absolute top-0 right-0 h-full w-80 max-w-[85vw] p-6 overflow-y-auto">
    <!-- Menu Header -->
    <div class="techno-menu-header flex justify-between items-center mb-8 pb-4">
      <div class="w-32">
        <img src={logo} alt={title || "Logo"} class="w-full" />
      </div>
      <button
        id="header-menu-close"
        class="techno-menu-close p-2 rounded-lg w-10 h-10 flex items-center justify-center transition-all duration-300"
        aria-label="Close menu"
        type="button"
      >
     <LucideIcon name="SquareX" width="18" height="18" />

      </button>
    </div>
    
    <!-- Menu Items with API Titles -->
    <nav class="techno-menu-nav flex-1" role="navigation" aria-label="Main navigation">
      <ul class="techno-menu-list space-y-2" role="list">
        <!-- Auto-generated navigation items -->
        {orderedAnchors.map((anchor, index) => {
          // Additional safety check during rendering
          if (!anchor || !anchor.component) {
            return null;
          }
          
          return (
            <li 
              class="techno-menu-item transition-all duration-300 ease-out"
              role="listitem"
              style={`--menu-item-index: ${index + 1}`}
            >
              <a
                href={`#${anchor.component}`}
                class="techno-menu-link block p-3 rounded-lg text-sm font-medium transition-all duration-300"
                data-anchor-target={anchor.componentData.title}
              >
                    {isArabic ?   anchor.componentData.title_ar : anchor.componentData.title_en}
                  </a>
            </li>
          );
        })}
      </ul>
    </nav>
  </div>
</div>