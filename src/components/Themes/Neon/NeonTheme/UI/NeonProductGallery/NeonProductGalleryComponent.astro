---
import "./NeonProductGalleryComponent.css";
import type { Attachment, BlockData, Image, Product, Sku } from "../../../../../../lib/api/types";

const product: Product = Astro.props.product;

const mainImage = product.image;
const skus: Sku[] = product.skus;
const attachments: Attachment[] = product.attachment;

// Use Set to ensure uniqueness
const gallerySet = new Set<string>();

// Add main image
gallerySet.add(mainImage);

// Add images from skus
for (const subImage of skus) {
  if (subImage.image && !subImage.image.includes('null')) {
    gallerySet.add(subImage.image);
  }
}

// Add images from attachments
for (const subImage of attachments) {
  if (subImage.path && !subImage.path.includes('null')) {
    gallerySet.add(subImage.path);
  }
}

// Convert back to array if needed
const gallery: string[] = Array.from(gallerySet);

// Gallery options
const autoPlay = true;
const autoPlayDelay = 5000;
const enableTouch = true;
---

<!-- Mobile-First Gallery with Tailwind Classes -->
<neon-gallery 
    class="w-full lg:w-1/2 lg:sticky lg:top-4 lg:self-start"
    data-gallery-auto-play={autoPlay}
    data-gallery-auto-play-delay={autoPlayDelay}
    data-gallery-enable-touch={enableTouch}
>
    <div class="flex flex-col gap-4 lg:gap-6">
        <!-- Main Image Display -->
        <div class="neon-gallery-main relative rounded-xl lg:rounded-2xl overflow-hidden shadow-lg lg:shadow-xl">
            <div class="relative aspect-square">
                <img
                    data-gallery-main-image
                    src={gallery[0]}
                    class="w-full h-full object-cover transition-all duration-300 hover:scale-105 cursor-zoom-in"
                    alt={product.name}
                    loading="eager"
                />
                
                <!-- Loading Spinner -->
                <div class="neon-loader absolute inset-0 flex items-center justify-center opacity-0 transition-opacity duration-300">
                    <div class="neon-spinner w-8 h-8 border-3 rounded-full animate-spin"></div>
                </div>
                
                <!-- Navigation Buttons -->
                <button
                    data-gallery-prev-btn
                    class="neon-nav-btn absolute left-2 lg:left-4 top-1/2 -translate-y-1/2 w-10 h-10 lg:w-12 lg:h-12 backdrop-blur-sm rounded-full flex items-center justify-center shadow-lg opacity-0 group-hover:opacity-100 transition-all duration-200 hover:scale-105"
                    aria-label="Previous image"
                >
                    <svg class="w-5 h-5 lg:w-6 lg:h-6" viewBox="0 0 24 24" fill="none">
                        <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                
                <button
                    data-gallery-next-btn
                    class="neon-nav-btn absolute right-2 lg:right-4 top-1/2 -translate-y-1/2 w-10 h-10 lg:w-12 lg:h-12 backdrop-blur-sm rounded-full flex items-center justify-center shadow-lg opacity-0 group-hover:opacity-100 transition-all duration-200 hover:scale-105"
                    aria-label="Next image"
                >
                    <svg class="w-5 h-5 lg:w-6 lg:h-6" viewBox="0 0 24 24" fill="none">
                        <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                
                <!-- Image Counter -->
                <div class="neon-counter absolute bottom-3 lg:bottom-4 left-1/2 -translate-x-1/2 backdrop-blur-sm px-3 py-1.5 lg:px-4 lg:py-2 rounded-full text-sm lg:text-base font-medium">
                    <div class="flex items-center gap-1">
                        <span data-gallery-current-index>1</span>
                        <span class="opacity-70">/</span>
                        <span data-gallery-total-images>{gallery.length}</span>
                    </div>
                    <!-- Progress Bar -->
                    <div class="neon-progress-track w-full h-0.5 rounded-full mt-1 overflow-hidden">
                        <div class="neon-progress-fill h-full transition-all duration-300" style={`width: ${(1 / gallery.length) * 100}%`}></div>
                    </div>
                </div>
                
                <!-- Zoom Indicator -->
                <div class="neon-zoom-indicator absolute top-3 lg:top-4 right-3 lg:right-4 w-7 h-7 lg:w-8 lg:h-8 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 cursor-pointer" data-zoom-trigger>
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                        <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
                        <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M8 11H14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M11 8V14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </div>
            </div>
        </div>
        
        <!-- Image Modal/Lightbox -->
        <div class="neon-modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[999] opacity-0 invisible transition-all duration-300" data-image-modal>
            <div class="relative max-w-[95vw] max-h-[95vh]  rounded-xl overflow-hidden shadow-2xl">
                <img
                    data-modal-image
                    class="object-contain w-full h-full"
                    alt=""
                />
                <button
                    data-modal-close
                    class="neon-close-btn absolute top-3 right-3 w-8 h-8 lg:w-10 lg:h-10 rounded-full flex items-center justify-center transition-all duration-200 hover:scale-105"
                    aria-label="Close image"
                >
                    <svg class="w-5 h-5 lg:w-6 lg:h-6" viewBox="0 0 24 24" fill="none">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Thumbnail Gallery -->
        <div class="neon-thumbnails-section rounded-lg lg:rounded-xl p-3 lg:p-4 shadow-md">
            <!-- Thumbnails Container -->
            <div class="overflow-hidden rounded-lg" data-thumbnails-container>
                <div class="neon-thumbnails-track flex gap-2 lg:gap-3 overflow-x-auto pb-2">
                    {
                        gallery.map((image, index) => (
                            <div class="relative flex-shrink-0">
                                <img
                                    src={image}
                                    class={`neon-thumbnail w-12 h-12 lg:w-16 lg:h-16 object-cover rounded-lg cursor-pointer border-2 transition-all duration-200 hover:scale-105 hover:shadow-md ${
                                        index === 0 
                                            ? 'neon-thumbnail-active' 
                                            : ''
                                    }`}
                                    data-gallery-thumbnail
                                    data-gallery-index={index}
                                    alt={`${product.name} - View ${index + 1}`}
                                    loading="lazy"
                                />
                            </div>
                        ))
                    }
                </div>
            </div>
        </div>
    </div>
</neon-gallery>

<script>
    import "./NeonProductGalleryComponent"
</script>