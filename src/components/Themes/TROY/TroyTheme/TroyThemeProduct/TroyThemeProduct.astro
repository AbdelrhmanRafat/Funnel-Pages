---
// This component displays the main product details page for the Troy theme.
// It includes a gallery, product information (name, price, description), and purchase options.
// Props:
// - product: An object of type Product, containing all details about the product.
// - purchaseOptions: An object of type BlockData, containing data for the purchase options/funnel.
import "./TroyThemeProduct.css";
import type {
    BlockData,
    OptionOption,
    Product,
} from "../../../../../lib/api/types";
import TroyThemeProductFunnel from "../TroyThemeProductFunnel/TroyThemeProductFunnel.astro";
import "./TroyThemeProduct.css";
import { getTranslation } from "../../../../../lib/utils/i18n/translations";
import { TroyProductInfoComponents } from "../../../../../lib/constants/themes";
import type { Language } from "../../../../../lib/utils/i18n/translations";
import TroyThemeRates from "../TroyThemeRates/TroyThemeRates.astro";
import TroyThemeFormFields from "../Troy_FormFields/TroyThemeFormFields.astro";
import TroyGalleryComponent from "../UI/TroyGallery/TroyGalleryComponent.astro";
import TroyOrderConfirmationNotice from "../Troy_OrderConfirmationNotice/TroyOrderConfirmationNotice.astro";



// Define render order for product info section - reorder as needed!
const PRODUCT_INFO_RENDER_ORDER = [
  TroyProductInfoComponents.Rating,
  TroyProductInfoComponents.ProductHeader,
  TroyProductInfoComponents.ProductDescription,
  TroyProductInfoComponents.PurchaseOptions,
  TroyProductInfoComponents.FormFields,
  TroyProductInfoComponents.OrderConfirmation,
];

// Retrieves product and purchaseOptions from Astro's props.
const product: Product = Astro.props.product;
const purchaseOptions: BlockData = Astro.props.purchaseOptions;
const formFieldsData: BlockData = Astro.props.formFieldsData;
const ratingData: BlockData = Astro.props.ratingData;
const galleryData: BlockData = Astro.props.galleryData;
const orderConfirmationNoticeData: BlockData = Astro.props.orderConfirmationNoticeData;

// Extracts color and size options from the product data
const colorSizeOptions: OptionOption[] = product.options[0].options;

// Get initial language from cookie during SSR
const currentLang: Language = (Astro.cookies.get("lang")?.value || "en") as Language;
const isArabic = currentLang === "ar";

// Helper function to check if component data is available
interface ComponentCheckResult {
  isComponentFound: boolean;
  componentData: any;
}

function isComponentDataAvailable(componentType: TroyProductInfoComponents): ComponentCheckResult {
  switch (componentType) {
    case TroyProductInfoComponents.Rating:
      return {
        isComponentFound: !!ratingData,
        componentData: ratingData,
      };
    case TroyProductInfoComponents.ProductHeader:
      return {
        isComponentFound: !!product,
        componentData: product,
      };
    case TroyProductInfoComponents.ProductDescription:
      return {
        isComponentFound: !!product && (!!product.description_ar || !!product.description_en),
        componentData: product,
      };
    case TroyProductInfoComponents.PurchaseOptions:
      return {
        isComponentFound: !!purchaseOptions,
        componentData: purchaseOptions,
      };
    case TroyProductInfoComponents.FormFields:
      return {
        isComponentFound: !!formFieldsData,
        componentData: formFieldsData,
      };
    case TroyProductInfoComponents.OrderConfirmation:
      return {
        isComponentFound: !!orderConfirmationNoticeData,
        componentData: orderConfirmationNoticeData,
      };
    default:
      return {
        isComponentFound: false,
        componentData: null,
      };
  }
}
---

<section id="troy-product-details" class="troy-section">
    <div class="flex flex-col lg:flex-row gap-5">
        <!-- Gallery Section -->
        {galleryData && <TroyGalleryComponent data={galleryData} />}
        
        <!-- Product Info Section with Array-Based Rendering -->
        <div class="lg:w-1/2 troy-product-info flex flex-col gap-3 justify-center items-center p-2 md:px-8 md:py-3 rounded-xl">
            {
                PRODUCT_INFO_RENDER_ORDER.map((componentType) => {
                    const componentCheck = isComponentDataAvailable(componentType);
                    
                    if (!componentCheck.isComponentFound) {
                        return null;
                    }

                    // Rating Component
                    if (componentType === TroyProductInfoComponents.Rating) {
                        return <TroyThemeRates ratingData={componentCheck.componentData} />;
                    }

                    // Product Header Component
                    if (componentType === TroyProductInfoComponents.ProductHeader) {
                        return (
                            <div class="w-full flex flex-col justify-start items-start gap-2 mb-8">
                                <div class="flex items-center gap-2">
                                    <span 
                                        class={product.is_active ? "troy-badge-success text-xs py-1 px-3 rounded-full font-medium" : "troy-badge-error text-xs py-1 px-3 rounded-full font-medium"}
                                        data-translate={product.is_active ? "product.available" : "product.notAvailable"}
                                    >
                                        {product.is_active
                                            ? getTranslation("product.available", currentLang)
                                            : getTranslation("product.notAvailable", currentLang)
                                        }
                                    </span>
                                    <div class="troy-product-sku text-sm">
                                        <span data-translate="product.productCode">
                                            {getTranslation("product.productCode", currentLang)}
                                        </span>
                                        <span>: {product.sku_code}</span>
                                    </div>
                                </div>
                                <h2 class="troy-product-title text-3xl lg:text-4xl font-bold leading-tight">
                                    {isArabic ? product.name_ar : product.name_en}
                                </h2>
                                <div class="troy-product-price flex justify-center items-center gap-2 text-4xl font-bold">
                                   <span>{product.price}</span>
                                    <span data-translate="productFunnel.currency"></span>
                                </div>
                            </div>
                        );
                    }

                    // Product Description Component
                    if (componentType === TroyProductInfoComponents.ProductDescription) {
                        return (
                            <div class="troy-product-description w-full">
                                <h3 class="troy-description-header text-2xl font-bold pb-3" data-translate="product.description">
                                    {getTranslation("product.description", currentLang)}
                                </h3>
                                <p
                                    class="troy-text-body leading-relaxed"
                                    set:html={isArabic ? product.description_ar : product.description_en}
                                />
                            </div>
                        );
                    }

                    // Purchase Options Component
                    if (componentType === TroyProductInfoComponents.PurchaseOptions) {
                        return (
                                <TroyThemeProductFunnel
                                    data={componentCheck.componentData}
                                    colorSizeOptions={colorSizeOptions}
                                />
                        );
                    }

                    // Form Fields Component
                    if (componentType === TroyProductInfoComponents.FormFields) {
                        return (
                                <TroyThemeFormFields data={componentCheck.componentData} />
                        );
                    }

                    // Order Confirmation Component
                    if (componentType === TroyProductInfoComponents.OrderConfirmation) {
                        return (
                                <TroyOrderConfirmationNotice data={componentCheck.componentData} />
                        );
                    }

                    return null;
                })
            }
        </div>
    </div>
</section>

<script>
    import "./TroyThemeProduct";
</script>