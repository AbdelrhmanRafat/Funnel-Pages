---
// ===============================================
// IMPORTS & DEPENDENCIES
// ===============================================
import "./TroyThemeFormFields.css";
import {
  getTranslation,
  type Language,
} from "../../../../../lib/utils/i18n/translations";
import type { BlockData, PaymentOption } from "../../../../../lib/api/types";
import TroySubmitOrderButton from "../UI/TroySubmitOrderButton/TroySubmitOrderButton.astro";

// ===============================================
// DATA INITIALIZATION & PROCESSING
// ===============================================
const data: BlockData = Astro.props.data;

// Get initial language from cookie during SSR
const currentLang: Language = (Astro.cookies.get("lang")?.value ||
  "en") as Language;
const isArabic = currentLang === "ar";

// Initialize arrays for cities and payment options
let cities: string[] = [];
let paymentOptions: PaymentOption[] = [];

if (data.cities !== null) cities = data.cities ?? [];
if (data.PaymentOptions !== null) paymentOptions = data.PaymentOptions ?? [];
---

<!-- =============================================== -->
<!-- MAIN FORM SECTION -->
<!-- =============================================== -->
<section id="troy-form" class="troy-form w-full p-3">
  <div class="mx-auto py-2 flex flex-col justify-center items-center gap-2">
    
    <!-- =============================================== -->
    <!-- FORM HEADER -->
    <!-- =============================================== -->
    <div class="text-center">
      <h5 class="troy-form-title" data-translate="form.completeOrder">
        {getTranslation("form.completeOrder")}
      </h5>
    </div>

    <!-- =============================================== -->
    <!-- MAIN FORM -->
    <!-- =============================================== -->
    <form class="w-full">
      <div class="mb-8">
        
        <!-- =============================================== -->
        <!-- PERSONAL INFORMATION SECTION -->
        <!-- =============================================== -->
        <h2
          class="troy-form-section-title mb-6"
          data-translate="form.personalInfo"
        >
          {getTranslation("form.personalInfo")}
        </h2>
        
        <div class="space-y-4">
          
          <!-- ========================================= -->
          <!-- FULL NAME INPUT FIELD -->
          <!-- ========================================= -->
          <div>
            <label
              class="troy-form-label block mb-2"
              data-translate="form.fullName"
            >
              {getTranslation("form.fullName")}
            </label>
            <input
              type="text"
              id="form-fullName"
              placeholder={data.full_name}
              class="troy-form-input text-right"
            />
            <span
              id="form-fullName-error"
              class="troy-form-error"
              style="display: none;"
            ></span>
          </div>

          <!-- ========================================= -->
          <!-- PHONE NUMBER INPUT FIELD -->
          <!-- ========================================= -->
          <div>
            <label
              class="troy-form-label block mb-2"
              data-translate="form.phoneNumber"
            >
              {getTranslation("form.phoneNumber")}
            </label>
            <input
              type="tel"
              id="form-phone"
              placeholder={data.phone}
              class="troy-form-input text-right"
            />
            <span
              id="form-phone-error"
              class="troy-form-error"
              style="display: none;"
            ></span>
          </div>

          <!-- ========================================= -->
          <!-- EMAIL INPUT FIELD -->
          <!-- ========================================= -->
          <div>
            <label
              class="troy-form-label block mb-2"
              data-translate="form.email"
            >
              {getTranslation("form.email")}
            </label>
            <input
              type="email"
              id="form-email"
              placeholder={getTranslation("form.enterEmail")}
              class="troy-form-input text-right"
            />
            <span
              id="form-email-error"
              class="troy-form-error"
              style="display: none;"
            ></span>
          </div>

          <!-- ========================================= -->
          <!-- ADDRESS TEXTAREA FIELD -->
          <!-- ========================================= -->
          <div>
            <label
              class="troy-form-label block mb-2"
              data-translate="form.address"
            >
              {getTranslation("form.address")}
            </label>
            <textarea
              id="form-address"
              placeholder="...."
              class="troy-form-input text-right min-h-[80px] resize-y"
            ></textarea>
            <span
              id="form-address-error"
              class="troy-form-error"
              style="display: none;"
            ></span>
          </div>

          <!-- ========================================= -->
          <!-- CITY SELECTION DROPDOWN -->
          <!-- ========================================= -->
          <div>
            <label
              class="troy-form-label block mb-2"
              data-translate="form.city"
            >
              {getTranslation("form.city")}
            </label>
            <select id="form-city" class="troy-form-input text-right">
              <option value="" data-translate="form.selectCity">
                {getTranslation("form.selectCity")}
              </option>
              {
                cities.map((city: string) => (
                  <option value={city.toLowerCase().replace(/\s+/g, "")}>
                    {city}
                  </option>
                ))
              }
            </select>
            <span
              id="form-city-error"
              class="troy-form-error"
              style="display: none;"
            ></span>
          </div>

          <!-- ========================================= -->
          <!-- PAYMENT OPTIONS SECTION -->
          <!-- ========================================= -->
          <div>
            <label
              class="troy-form-label block mb-2"
              data-translate="form.paymentOptions"
            >
              {getTranslation("form.paymentOptions")}
            </label>
            <div
              class="space-y-3"
              role="radiogroup"
              aria-label="Payment Method"
            >
              {
                paymentOptions.map((option, index) => {
                  const value = option.id;
                  const id = `payment-${value}`;
                  const isChecked = index === 0;
                  
                  return (
                    <div class="troy-form-delivery-option">
                      <input
                        type="radio"
                        id={id}
                        name="payment-option"
                        value={value}
                        class="troy-form-radio"
                        checked={isChecked}
                      />
                      <label
                        for={id}
                        class="troy-form-delivery-option-content"
                      >
                        <div class="flex justify-between items-center">
                          <div class="flex-1 flex flex-col justify-start items-start gap-2">
                            <span class="troy-form-delivery-option-label">
                              {option.label[currentLang]}
                            </span>
                            <span class="troy-form-delivery-option-description">
                              {option.description[currentLang]}
                            </span>

                            {/* Payment method images */}
                            {option.images && option.images.length > 0 && (
                              <div class="flex justify-start items-center flex-wrap gap-4">
                                {option.images.map((imageSrc) => (
                                  <div class="w-8 h-8 flex justify-center items-center">
                                    <img
                                      src={imageSrc}
                                      alt={option.label[currentLang]}
                                      class="w-full"
                                    />
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>

                          {/* Custom radio indicator */}
                          <div class="troy-form-radio-indicator">
                            <div class="troy-form-radio-dot" />
                          </div>
                        </div>
                      </label>
                    </div>
                  );
                })
              }
            </div>
            <span
              id="form-payment-error"
              class="troy-form-error"
              style="display: none;"
            ></span>
          </div>

          <!-- ========================================= -->
          <!-- NOTES TEXTAREA FIELD -->
          <!-- ========================================= -->
          <div>
            <label
              class="troy-form-label block mb-2"
              data-translate="form.notes"
            >
              {getTranslation("form.notes")}
            </label>
            <textarea
              id="form-notes"
              placeholder=""
              class="troy-form-input text-right min-h-[100px] resize-y"
            ></textarea>
            <span
              id="form-notes-error"
              class="troy-form-error"
              style="display: none;"
            ></span>
          </div>

        </div>
      </div>
      
      <!-- =============================================== -->
      <!-- SUBMIT BUTTON SECTION -->
      <!-- =============================================== -->
      <TroySubmitOrderButton />
    </form>
  </div>
</section>

<!-- =============================================== -->
<!-- CLIENT-SIDE SCRIPTS -->
<!-- =============================================== -->
<script>
  import "./TroyThemeFormFields";
</script>